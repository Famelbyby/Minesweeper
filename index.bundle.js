(()=>{"use strict";function e(e){return e.join(" ")}class t{constructor(e,t,n,s){this.componentText=e,this.componentClass=s,this.componentAttrs=n,this.innerComponents=t}addInnerComponents(e,t=-1){-1===t?this.innerComponents.push(...e):this.innerComponents.splice(t,0,...e)}removeInnerComponents(e=-1,t=1){-1===e?this.innerComponents.pop():this.innerComponents.splice(e,t)}exchangeInnerComponents(e,t=-1){-1===t&&this.addInnerComponents(e),this.innerComponents.splice(t,e.length,...e)}getAttr(e){return console.log(this.componentAttrs[e]),this.componentAttrs[e]}toggleAttr(e,t=0){const n=this.componentAttrs[e.key];switch(t){case 0:t=-1===n?1:-1;case 1:this.componentAttrs[e.key]=e.value;break;case-1:-1!==n&&delete this.componentAttrs[e.key]}}toggleClass(e,t=0){const n=this.componentClass.indexOf(e);switch(t){case 0:t=-1===n?1:-1;case 1:-1===n&&this.componentClass.push(e);break;case-1:-1!==n&&this.componentClass.splice(n,1)}}toggleText(e){this.componentText=e}update(e=0){const t=document.getElementById(this.componentAttrs.id);if(!t)return;const n=t.attributes,s=Array.from(t.classList);for(const e of Object.keys(n))this.componentAttrs[e]||t.removeAttribute(e);for(let[e,n]of Object.entries(this.componentAttrs)){const s=String(n);t.setAttribute(e,s)}for(let e of s)this.componentClass.includes(e)||t.classList.remove(e);for(let e of this.componentClass)t.classList.add(e);switch(e){case 0:break;case 1:t.innerHTML=this.componentText}}addListeners(e){const t=document.getElementById(this.componentAttrs.id);e.forEach((({event:e,func:n})=>{null==t||t.addEventListener(e,n)}))}}class n extends t{constructor(e,t,n){super("",e,t,n)}render(){let t="<button ";for(const[e,n]of Object.entries(this.componentAttrs))t+=`${e}="${n}" `;return t+=`class="${e(this.componentClass)}">`,Array.from(this.innerComponents).forEach((e=>{t+=e.render()})),t+"</button>"}}class s extends t{constructor(e,t){super("",[],e,t)}render(){let t="<img ";for(const[e,n]of Object.entries(this.componentAttrs))t+=`${e}="${n}" `;return t+`class="${e(this.componentClass)}" />`}}const o=1,a=-1,i=0,l=1,r=3,c=4,d=30,m=30,_=-1,u=1,h=1,p=-1,f=-1,g=0,v=[[0,1],[1,1],[1,0],[1,-1],[0,-1],[-1,-1],[-1,0],[-1,1]],y=["","deepskyblue","blue","darkblue","indianred","firebrick","darkred","brown","black"];class w extends t{constructor(e,t){super("",[],e,t)}updateValue(e,t=1,n=1){const s=document.getElementById(this.componentAttrs.id);let o;return o=String("mines"===e?function(e,t,n){let s=Number(e);return s>=t*n&&(s=t*n-1),s<1&&(s=1),s}(s.value,t,n):function(e,t){let n=Number(e);switch(t){case"strings":n>1e3&&(n=1e3),n<10&&(n=10);case"columns":n>1e3&&(n=1e3),n<10&&(n=10)}return n}(s.value,e)),this.toggleAttr({key:"value",value:o}),o}render(){let t="<input ";for(const[e,n]of Object.entries(this.componentAttrs))t+=`${e}="${n}" `;return`${t} class="${e(this.componentClass)}" />`}}class x extends t{constructor(e,t,n){super("",e,t,n)}render(){let t="<div ";for(const[e,n]of Object.entries(this.componentAttrs))t+=`${e}="${n}" `;return t+=`class="${e(this.componentClass)}">`,this.innerComponents.forEach((e=>{t+=e.render()})),t+"</div>"}}class b extends t{constructor(e,t,n){super(e,[],t,n)}render(){let t="<span ";for(const[e,n]of Object.entries(this.componentAttrs))t+=`${e}="${n}" `;return t+`class="${e(this.componentClass)}">${this.componentText}</span>`}}class C extends t{constructor(e,t,n){super("",[],t,n),this.minesField=[],this.hasGenerated=!1,this.currentDifX=0,this.currentDifY=0,this.fieldParameters=e}generateField(e,t){const n=1-+this.fieldParameters.mines/(+this.fieldParameters.strings*+this.fieldParameters.columns);this.flagImage=document.getElementById("flag-img");let s=+this.fieldParameters.mines;const o=+this.fieldParameters.strings,a=+this.fieldParameters.columns;let i=0,l=0,r=o*a;for(let e=0;e<o;++e)this.minesField.push([]);for(this.minesField[t][e]={fieldValue:0,openState:0};s>0;)i===e&&l===t||(Math.random()>n||r===s)&&(this.minesField[l][i]={fieldValue:_,openState:0},--s),++i,--r,i===a&&(i=0,++l);this.minesField.forEach(((e,t)=>{var n;for(let e=0;e<a;++e)if(((null===(n=this.minesField[t][e])||void 0===n?void 0:n.fieldValue)||0)!==_){let n=0;v.forEach((s=>{var i;const l=t+s[0],r=e+s[1];l>=0&&l<o&&r>=0&&r<a&&(null===(i=this.minesField[l][r])||void 0===i?void 0:i.fieldValue)===_&&++n})),this.minesField[t][e]={fieldValue:n,openState:0}}}))}openAllCeils(){let e=0;const t=document.getElementById("bomb-img");this.minesField.forEach(((n,s)=>{let o=0;n.forEach(((n,a)=>{if(0===n.openState)switch(this.minesField[s][a].openState=1,this.context.fillStyle="#d1d1d1",this.context.fillRect(o,e,d,m),this.context.strokeRect(o,e,d,m),n.fieldValue){case 0:break;case _:this.context.drawImage(t,o,e,d,m);break;default:this.context.strokeStyle=y[n.fieldValue],this.context.strokeText(String(n.fieldValue),o+15,e+15),this.context.strokeStyle="white",this.context.fillStyle="gray"}o+=d})),e+=m}))}openCurrentCeil(e,t,n,s){const o=this.minesField[n][s];if(o.fieldValue===_)return _;if(1===o.openState)return 0;const a=[{yCeil:n,xCeil:s,yCoor:t,xCoor:e}];let i=0;for(;a.length>0;){const e=a[0];a.shift();const t=this.minesField[e.yCeil][e.xCeil].fieldValue,n=this.minesField[e.yCeil][e.xCeil].openState;t!==_&&0===n&&(++i,this.minesField[e.yCeil][e.xCeil].openState=1,this.context.fillStyle="#d1d1d1",this.context.fillRect(e.xCoor,e.yCoor,d,m),this.context.strokeRect(e.xCoor,e.yCoor,d,m),0!==t?(this.context.strokeStyle=y[t],this.context.strokeText(String(t),e.xCoor+15,e.yCoor+15),this.context.strokeStyle="white",this.context.fillStyle="gray"):v.forEach((t=>{const n=t[0],s=t[1],o=n+e.yCeil,i=s+e.xCeil;o>=0&&o<+this.fieldParameters.strings&&i>=0&&i<+this.fieldParameters.columns&&0===this.minesField[o][i].openState&&this.minesField[o][i].fieldValue!==_&&a.push({yCeil:o,xCeil:i,yCoor:e.yCoor+n*m,xCoor:e.xCoor+s*d})})))}return i}pressEventHandler(e){let t=e.changedTouches?e.changedTouches[0].pageX:e.pageX,n=e.changedTouches?e.changedTouches[0].pageY:e.pageY;t-=this.canvas.offsetLeft+12,n-=this.canvas.offsetTop+12;const s=t-t%d,o=n-n%m,a=this.currentDifX+Math.floor(s/d),i=this.currentDifY+Math.floor(o/m);return this.hasGenerated||(this.generateField(a,i),this.hasGenerated=!0),this.openCurrentCeil(s,o,i,a)}addFlagAtCeil(e){let t=e.changedTouches?e.changedTouches[0].pageX:e.pageX,n=e.changedTouches?e.changedTouches[0].pageY:e.pageY;t-=this.canvas.offsetLeft+12,n-=this.canvas.offsetTop+12;const s=t-t%d,o=n-n%m,a=this.currentDifX+Math.floor(s/d),i=this.currentDifY+Math.floor(o/m);switch(this.hasGenerated||(this.generateField(a,i),this.hasGenerated=!0),this.minesField[i][a].openState){case 0:this.context.drawImage(this.flagImage,s,o,d,m),this.minesField[i][a].openState=2;break;case 2:this.context.strokeStyle="white",this.context.fillStyle="gray",this.context.lineWidth=1,this.context.fillRect(s,o,d,m),this.context.strokeRect(s,o,d,m),this.minesField[i][a].openState=0}}refillCanvas(e,t){this.currentDifX+=e,this.currentDifX+20>+this.fieldParameters.columns&&(this.currentDifX=+this.fieldParameters.columns-20),this.currentDifX<0&&(this.currentDifX=0),this.currentDifY+=t,this.currentDifY+20>+this.fieldParameters.strings&&(this.currentDifY=+this.fieldParameters.strings-20),this.currentDifY<0&&(this.currentDifY=0),this.context.strokeStyle="white",this.context.fillStyle="gray",this.context.lineWidth=1;let n=0;for(let e=0;e<Math.min(20,+this.fieldParameters.strings);++e){let t=0;for(let s=0;s<Math.min(20,+this.fieldParameters.columns);++s){const o=this.minesField[this.currentDifY+e][this.currentDifX+s];switch(1===o.openState&&(this.context.fillStyle="#d1d1d1"),this.context.fillRect(t,n,d,m),this.context.strokeRect(t,n,d,m),o.openState){case 1:0!==o.fieldValue&&(this.context.strokeStyle=y[o.fieldValue],this.context.strokeText(String(o.fieldValue),t+15,n+15),this.context.strokeStyle="white",this.context.fillStyle="gray");break;case 2:this.context.drawImage(this.flagImage,t,n,d,m)}this.context.fillStyle="gray",t+=d}n+=m}}fillCanvas(){this.canvas=document.getElementById(this.componentAttrs.id),this.context=this.canvas.getContext("2d");const{strings:e,columns:t}=this.fieldParameters,n=d*+t,s=m*+e;n>600?this.canvas.style.width="600px":(this.toggleAttr({key:"width",value:`${n}`}),this.canvas.style.width=`${n}px`),s>600?this.canvas.style.height="600px":(this.toggleAttr({key:"height",value:`${s}`}),this.canvas.style.height=`${s}px`),this.update(),this.context.strokeStyle="white",this.context.fillStyle="gray",this.context.lineWidth=1;let o=0;for(let n=0;n<+e;++n){let e=0;for(let n=0;n<+t;++n)this.context.fillRect(e,o,d,m),this.context.strokeRect(e,o,d,m),e+=d;o+=m}}render(){let t="<canvas ";for(const[e,n]of Object.entries(this.componentAttrs))t+=`${e}="${n}" `;return t+`class="${e(this.componentClass)}"></canvas>`}}class $ extends t{constructor(e,t,n){super(String(e),[],t,n)}setStartTime(e){this.componentText=e}start(e=1){this.intervalId=setInterval((()=>{this.componentText=String(Number(this.componentText)+1),this.update(1)}),1e3*e)}render(){let t="<span ";for(const[e,n]of Object.entries(this.componentAttrs))t+=`${e}="${n}" `;return t+=`class="${e(this.componentClass)}">`,t+`${this.componentText}</span>`}stop(){this.intervalId&&clearInterval(this.intervalId)}}function k(){const e=localStorage.getItem("strings")||9,t=localStorage.getItem("columns")||9,o=localStorage.getItem("mines")||10,a=localStorage.getItem("theme")||"moon";let d=+e*+t,m=i;const v=new s({id:"flag-img",src:"images/flag.webp"},["game-field__flag-img"]),y=new s({id:"bomb-img",src:"images/bomb.webp"},["game-field__bomb-img"]),w=new s({id:"smile-img",src:"images/smile.webp"},["game-field__smile-img"]),A=new n([w],{id:"smile-button"},["game-field__smile-button",`game-field__smile-button_${a}`]),I=new $(0,{id:"game-timer"},["game-field__timer",`game-field__timer_${a}`]),T=new n([new b("Выйти в меню",{},["game-field__restart-span"])],{id:"exit-button"},["game-field__exit-button",`game-field__exit-button_${a}`]),L=new x([v,y,A,I,T],{id:"game-field__header-panel"},["game-field__header-panel"]),F=new C({strings:e,columns:t,mines:o},{id:"mines-field__canvas",width:600,height:600},["mines-field__canvas"]);document.body.innerHTML=L.render()+F.render(),F.fillCanvas(),A.addListeners([{event:"click",func:()=>{switch(m){case i:I.start(),w.toggleAttr({key:"src",value:"images/happy-face.webp"}),m=0;break;case r:case c:case l:return I.stop(),void k()}w.update(),++m}}]),T.addListeners([{event:"click",func:()=>{I.stop(),S()}}]),F.addListeners([{event:"mousedown",func:e=>{switch(e.preventDefault(),m){case r:case i:case c:break;case l:if(2===e.buttons)return void F.addFlagAtCeil(e);const t=F.pressEventHandler(e);t===_?(F.openAllCeils(),m=c,w.toggleAttr({key:"src",value:"images/sad.webp"}),w.update(),I.stop()):(d-=t,d===+o&&(m=r,w.toggleAttr({key:"src",value:"images/cool.webp"}),F.openAllCeils(),w.update(),I.stop()))}}}]),F.addListeners([{event:"contextmenu",func:e=>{e.preventDefault()}}]);let D=!1;document.onkeydown=e=>{if(m===l&&!D){switch(D=!0,e.code){case"KeyW":case"ArrowUp":F.refillCanvas(g,f);break;case"KeyA":case"ArrowLeft":F.refillCanvas(p,g);break;case"KeyS":case"ArrowDown":F.refillCanvas(g,u);break;case"KeyD":case"ArrowRight":F.refillCanvas(h,g)}setTimeout((()=>{D=!1}),100)}}}function S(){const e=localStorage.getItem("theme")||"moon";document.body.classList.remove("body_moon","body_sunny"),document.body.classList.add(`body_${e}`);const t=new x([new b("Начинающий",{},["mode__header-span"]),new b("Строк: 9",{id:"mode__span-strings_easy","data-value":9},["mode__content-span",`mode__content-span_${e}`]),new b("Столбцов: 9",{id:"mode__span-columns_easy","data-value":9},["mode__content-span",`mode__content-span_${e}`]),new b("Мин: 10",{id:"mode__span-mines_easy","data-value":10},["mode__content-span",`mode__content-span_${e}`])],{id:"mode__panel_easy"},["mode__panel",`mode__panel_${e}`]),i=new x([new b("Продвинутый",{},["mode__header-span"]),new b("Строк: 16",{id:"mode__span-strings_middle","data-value":16},["mode__content-span",`mode__content-span_${e}`]),new b("Столбцов: 16",{id:"mode__span-columns_middle","data-value":16},["mode__content-span",`mode__content-span_${e}`]),new b("Мин: 40",{id:"mode__span-mines_middle","data-value":40},["mode__content-span",`mode__content-span_${e}`])],{id:"mode__panel_middle"},["mode__panel",`mode__panel_${e}`]),l=new x([new b("Эксперт",{},["mode__header-span"]),new b("Строк: 16",{id:"mode__span-strings_hard","data-value":16},["mode__content-span",`mode__content-span_${e}`]),new b("Столбцов: 30",{id:"mode__span-columns_hard","data-value":30},["mode__content-span",`mode__content-span_${e}`]),new b("Мин: 99",{id:"mode__span-mines_hard","data-value":99},["mode__content-span",`mode__content-span_${e}`])],{id:"mode__panel_hard"},["mode__panel",`mode__panel_${e}`]),r=new b("Строк: ",{id:"mode__span-strings_custom","data-value":16},["mode__content-span",`mode__content-span_${e}`]),c=new w({id:"mode__input-strings_custom",value:"16",type:"number",max:1e3,min:10},["mode__content-input"]),d=new b("Столбцов: ",{id:"mode__span-columns_custom","data-value":16},["mode__content-span",`mode__content-span_${e}`]),m=new w({id:"mode__input-columns_custom",value:"16",type:"number",max:1e3,min:10},["mode__content-input"]),_=new b("Мин: ",{id:"mode__span-mines_custom","data-value":50},["mode__content-span",`mode__content-span_${e}`]),u=new w({id:"mode__input-mines_custom",value:"50",type:"number"},["mode__content-input"]),h=new x([new b("Свой режим",{},["mode__header-span"]),new x([r,c],{id:"mode__panel-strings_custom"},["mode__content-panel"]),new x([d,m],{id:"mode__panel-columns_custom"},["mode__content-panel"]),new x([_,u],{id:"mode__panel-columns_custom"},["mode__content-panel"])],{id:"mode__panel_custom"},["mode__panel",`mode__panel_${e}`]),p=new s({src:`images/${e}.webp`},["theme-mode__img"]),f=new n([p],{id:"theme-mode__button"},["theme-mode__button",`theme-mode__button_${e}`]),g=new n([new b("Начать игру",{},[])],{id:"footer-menu__button",type:"button"},["footer-menu__button",`footer-menu__button_${e}`]);function v(n){const s=document.getElementById(`mode__span-strings_${n}`).dataset.value,r=document.getElementById(`mode__span-columns_${n}`).dataset.value,c=document.getElementById(`mode__span-mines_${n}`).dataset.value;switch(localStorage.setItem("strings",s),localStorage.setItem("columns",r),localStorage.setItem("mines",c),i.toggleClass(`mode__panel_focused_${e}`,a),l.toggleClass(`mode__panel_focused_${e}`,a),t.toggleClass(`mode__panel_focused_${e}`,a),h.toggleClass(`mode__panel_focused_${e}`,a),n){case"easy":t.toggleClass(`mode__panel_focused_${e}`,o);break;case"middle":i.toggleClass(`mode__panel_focused_${e}`,o);break;case"hard":l.toggleClass(`mode__panel_focused_${e}`,o);break;case"custom":h.toggleClass(`mode__panel_focused_${e}`,o)}i.update(),l.update(),t.update(),h.update()}const y=new x([new x([new b("Выберите сложность",{id:"header-menu__span"},["header-menu__span",`header-menu__span_${e}`])],{id:"header-menu__panel"},["header-menu__panel",`header-menu__panel_${e}`]),f,new x([t,i,l,h],{id:"content-menu__panel"},["content-menu__panel",`content-menu__panel_${e}`]),new x([g],{id:"footer-menu__panel"},["footer-menu__panel",`footer-menu__panel_${e}`])],{id:"menu-choose-mode"},["menu-choose-mode",`menu-choose-mode_${e}`]);document.body.innerHTML=y.render(),v("easy"),f.addListeners([{event:"click",func:()=>{"images/moon.webp"===p.getAttr("src")?(p.toggleAttr({key:"src",value:"images/sun.webp"}),localStorage.setItem("theme","sunny")):(p.toggleAttr({key:"src",value:"images/moon.webp"}),localStorage.setItem("theme","moon")),S()}}]),t.addListeners([{event:"click",func:()=>{v("easy")}}]),i.addListeners([{event:"click",func:()=>{v("middle")}}]),l.addListeners([{event:"click",func:()=>{v("hard")}}]),c.addListeners([{event:"change",func:()=>{r.toggleAttr({key:"data-value",value:c.updateValue("strings")}),r.update(),v("custom")}}]),m.addListeners([{event:"change",func:()=>{d.toggleAttr({key:"data-value",value:m.updateValue("columns")}),d.update(),v("custom")}}]),u.addListeners([{event:"change",func:()=>{_.toggleAttr({key:"data-value",value:u.updateValue("mines",+localStorage.getItem("strings"),+localStorage.getItem("columns"))}),_.update(),v("custom")}}]),h.addListeners([{event:"click",func:()=>{v("custom")}}]),g.addListeners([{event:"click",func:()=>{k()}}])}S()})();